<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#020204">
    <title>HoloWorld Mobile | Xavier OS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;500;700&display=swap" rel="stylesheet">

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; touch-action: none; }
        body { 
            background: #020204; 
            color: #e0e0e0; 
            font-family: 'Rajdhani', sans-serif;
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
        }

        #canvas-container { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            z-index: 1;
            touch-action: none;
        }

        .ui-layer { 
            position: fixed; 
            z-index: 10; 
            pointer-events: none;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 1rem;
        }

        .pointer-events-auto { pointer-events: auto; }
        .font-orbitron { font-family: 'Orbitron', sans-serif; }

        /* Mobile-optimized loading */
        #loader {
            position: fixed; inset: 0; background: #020204; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.5s ease;
        }

        .loader-ring {
            width: 80px; height: 80px;
            border: 3px solid transparent;
            border-top: 3px solid #00f0ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* Mobile glass panels */
        .holo-panel {
            background: rgba(10, 14, 39, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(0, 240, 255, 0.2);
            border-radius: 16px;
            pointer-events: auto;
        }

        /* Touch-optimized buttons */
        .quantum-btn {
            background: linear-gradient(135deg, rgba(0,240,255,0.15), rgba(176,38,255,0.15));
            border: 1px solid rgba(0,240,255,0.4);
            color: #00f0ff;
            padding: 12px 20px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 14px;
            min-height: 44px; /* iOS touch target */
            min-width: 44px;
            transition: all 0.2s;
            active: scale(0.95);
        }

        .quantum-btn:active {
            transform: scale(0.95);
            background: rgba(0,240,255,0.3);
        }

        /* Mobile-specific controls */
        .mobile-controls {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            max-width: 300px;
        }

        /* Quality indicator */
        .quality-badge {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
            z-index: 20;
        }

        .quality-high { background: rgba(0, 255, 136, 0.2); border: 1px solid #00ff88; color: #00ff88; }
        .quality-med { background: rgba(255, 193, 7, 0.2); border: 1px solid #ffc107; color: #ffc107; }
        .quality-low { background: rgba(255, 68, 68, 0.2); border: 1px solid #ff4444; color: #ff4444; }

        /* Error message */
        .webgl-error {
            position: fixed; inset: 0; background: #020204; z-index: 10000;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            padding: 20px;
            text-align: center;
        }

        .gesture-hint {
            position: absolute;
            bottom: 200px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 12px;
            color: #888;
            pointer-events: none;
            animation: fadeOut 3s forwards;
            animation-delay: 2s;
        }

        @keyframes fadeOut {
            to { opacity: 0; }
        }

        /* Prevent text selection */
        .no-select {
            user-select: none;
            -webkit-user-select: none;
        }
    </style>
</head>
<body class="no-select">

    <!-- Loading Screen -->
    <div id="loader">
        <div class="loader-ring mb-4"></div>
        <h1 class="font-orbitron text-xl font-bold text-cyan-400 mb-2">HOLOVERSE</h1>
        <p class="text-gray-500 text-sm" id="loading-text">Detecting GPU...</p>
        <p class="text-gray-600 text-xs mt-2" id="device-info"></p>
    </div>

    <!-- WebGL Error Fallback -->
    <div id="webgl-error" class="webgl-error">
        <div class="text-4xl mb-4">‚ö†Ô∏è</div>
        <h2 class="font-orbitron text-xl text-red-400 mb-2">WebGL Unavailable</h2>
        <p class="text-gray-400 text-sm mb-4">Your browser blocked WebGL. Try:</p>
        <ul class="text-gray-500 text-xs text-left space-y-2 mb-6">
            <li>‚Ä¢ Chrome or Safari (not Samsung Internet)</li>
            <li>‚Ä¢ Disable battery saver mode</li>
            <li>‚Ä¢ Enable "Desktop site" option</li>
        </ul>
        <button onclick="location.href='index.html'" class="quantum-btn">Return to Hub</button>
    </div>

    <!-- Quality Badge -->
    <div id="quality-badge" class="quality-badge quality-high">Ultra</div>

    <!-- 3D Canvas -->
    <div id="canvas-container"></div>

    <!-- Gesture Hint -->
    <div class="gesture-hint">üëÜ Drag to rotate ‚Ä¢ Pinch to zoom</div>

    <!-- UI Layer -->
    <div class="ui-layer">
        <!-- Header -->
        <header class="flex justify-between items-start">
            <div class="holo-panel p-3 flex items-center gap-3">
                <button onclick="window.location.href='index.html'" class="text-gray-400 hover:text-cyan-400 transition text-xl pointer-events-auto">‚Üê</button>
                <div>
                    <h1 class="font-orbitron text-lg font-bold text-cyan-400">HOLOVERSE</h1>
                    <p class="text-[10px] text-gray-400 font-mono" id="fps-counter">60 FPS</p>
                </div>
            </div>

            <button onclick="toggleAutoRotate()" id="rotate-btn" class="holo-panel p-3 text-cyan-400 pointer-events-auto">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M23 4v6h-6M1 20v-6h6"/>
                    <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                </svg>
            </button>
        </header>

        <!-- Controls -->
        <div class="flex flex-col gap-3 items-end mb-4">
            <div class="holo-panel p-3 w-full max-w-xs">
                <h3 class="font-orbitron text-xs font-bold text-purple-400 mb-2 uppercase">Environment</h3>
                <div class="mobile-controls">
                    <button onclick="setQuality('high')" class="quantum-btn text-xs">Ultra</button>
                    <button onclick="setQuality('medium')" class="quantum-btn text-xs" style="border-color: #b026ff; color: #b026ff;">Balanced</button>
                    <button onclick="setQuality('low')" class="quantum-btn text-xs" style="border-color: #ff4444; color: #ff4444;">Performance</button>
                    <button onclick="resetCamera()" class="quantum-btn text-xs" style="border-color: #ffc107; color: #ffc107;">Reset</button>
                </div>
            </div>
        </div>
    </div>

    <script src="guard.js"></script>
    <script>
        // üéÆ MOBILE-OPTIMIZED 3D ENGINE
        let scene, camera, renderer, controls;
        let mainObject, particleSystem;
        let autoRotate = true;
        let quality = 'high';
        let isMobile = false;
        let frameCount = 0;
        let lastTime = performance.now();
        let fps = 60;

        // Device Detection
        function detectDevice() {
            const userAgent = navigator.userAgent;
            const isAndroid = /Android/i.test(userAgent);
            const isiOS = /iPhone|iPad|iPod/i.test(userAgent);
            isMobile = isAndroid || isiOS;

            // Detect GPU tier
            const canvas = document.createElement('canvas');
            const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
            const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
            const renderer = debugInfo ? gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL) : 'unknown';

            document.getElementById('device-info').textContent = renderer;

            // Auto-set quality based on device
            if (renderer.includes('Mali') || renderer.includes('Adreno 5')) {
                quality = 'low';
                document.getElementById('quality-badge').className = 'quality-badge quality-low';
                document.getElementById('quality-badge').textContent = 'Performance';
            } else if (isMobile) {
                quality = 'medium';
                document.getElementById('quality-badge').className = 'quality-badge quality-med';
                document.getElementById('quality-badge').textContent = 'Balanced';
            }

            return { isMobile, renderer };
        }

        // Initialize
        function init() {
            try {
                const device = detectDevice();
                document.getElementById('loading-text').textContent = 'Loading 3D Engine...';

                const container = document.getElementById('canvas-container');

                // Scene
                scene = new THREE.Scene();
                scene.fog = new THREE.FogExp2(0x020204, isMobile ? 0.03 : 0.02);

                // Camera
                camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
                camera.position.set(5, 3, 5);

                // Renderer - Mobile optimized
                renderer = new THREE.WebGLRenderer({ 
                    antialias: !isMobile, // Disable AA on mobile for speed
                    alpha: false,
                    powerPreference: "high-performance",
                    stencil: false,
                    depth: true
                });
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.setPixelRatio(Math.min(window.devicePixelRatio, isMobile ? 1.5 : 2));
                renderer.shadowMap.enabled = !isMobile; // Disable shadows on mobile
                renderer.toneMapping = THREE.ACESFilmicToneMapping;
                renderer.toneMappingExposure = 1.0;
                container.appendChild(renderer.domElement);

                // Controls - Touch optimized
                controls = new THREE.OrbitControls(camera, renderer.domElement);
                controls.enableDamping = true;
                controls.dampingFactor = 0.1;
                controls.enableZoom = true;
                controls.enablePan = false;
                controls.maxPolarAngle = Math.PI / 2;
                controls.minDistance = 2;
                controls.maxDistance = 15;
                controls.touchAction = 'none'; // Prevent page scroll

                // Lighting - Simplified for mobile
                createLighting();

                // Objects - Quality based
                createMainObject();
                createParticles();
                createFloor();

                // Event Listeners
                window.addEventListener('resize', onWindowResize, { passive: true });

                // Remove loader
                setTimeout(() => {
                    document.getElementById('loader').style.opacity = '0';
                    setTimeout(() => document.getElementById('loader').remove(), 500);
                }, 1000);

                animate();

            } catch (e) {
                console.error('WebGL Error:', e);
                document.getElementById('webgl-error').style.display = 'flex';
                document.getElementById('loader').style.display = 'none';
            }
        }

        function createLighting() {
            // Ambient
            const ambient = new THREE.AmbientLight(0x404040, 0.6);
            scene.add(ambient);

            // Main directional
            const mainLight = new THREE.DirectionalLight(0x00f0ff, isMobile ? 0.8 : 1.2);
            mainLight.position.set(5, 10, 5);
            if (!isMobile) {
                mainLight.castShadow = true;
                mainLight.shadow.mapSize.width = 1024;
                mainLight.shadow.mapSize.height = 1024;
            }
            scene.add(mainLight);

            // Rim light
            const rimLight = new THREE.DirectionalLight(0xb026ff, 0.6);
            rimLight.position.set(-5, 5, -5);
            scene.add(rimLight);
        }

        function createMainObject() {
            // Clear existing
            if (mainObject) scene.remove(mainObject);

            let geometry, material;

            if (quality === 'high') {
                // Ferrari mode - Complex
                geometry = new THREE.TorusKnotGeometry(1.5, 0.4, 128, 16, 2, 3);
                material = new THREE.MeshPhysicalMaterial({
                    color: 0x222222,
                    metalness: 1.0,
                    roughness: 0.15,
                    clearcoat: 1.0,
                    emissive: 0x00f0ff,
                    emissiveIntensity: 0.1
                });
            } else if (quality === 'medium') {
                // Porsche mode - Balanced
                geometry = new THREE.TorusKnotGeometry(1.5, 0.4, 64, 12, 2, 3);
                material = new THREE.MeshStandardMaterial({
                    color: 0x333333,
                    metalness: 0.9,
                    roughness: 0.2
                });
            } else {
                // Performance mode - Simple but sleek
                geometry = new THREE.IcosahedronGeometry(1.8, 2);
                material = new THREE.MeshStandardMaterial({
                    color: 0x00f0ff,
                    metalness: 0.8,
                    roughness: 0.3,
                    wireframe: true
                });
            }

            mainObject = new THREE.Mesh(geometry, material);
            mainObject.position.y = 1.5;
            if (!isMobile) mainObject.castShadow = true;
            scene.add(mainObject);

            // Inner core (all qualities)
            const coreGeo = new THREE.IcosahedronGeometry(0.8, 0);
            const coreMat = new THREE.MeshBasicMaterial({ 
                color: 0x00f0ff,
                wireframe: true,
                transparent: true,
                opacity: 0.8
            });
            const core = new THREE.Mesh(coreGeo, coreMat);
            core.position.y = 1.5;
            mainObject.add(core);
            mainObject.userData.core = core;

            // Rings
            if (quality !== 'low') {
                const ringGeo = new THREE.TorusGeometry(2.5, 0.03, 8, 64);
                const ringMat = new THREE.MeshBasicMaterial({ 
                    color: 0xb026ff, 
                    transparent: true, 
                    opacity: 0.6 
                });
                const ring = new THREE.Mesh(ringGeo, ringMat);
                ring.position.y = 1.5;
                ring.rotation.x = Math.PI / 2;
                scene.add(ring);
                mainObject.userData.ring = ring;
            }
        }

        function createParticles() {
            if (particleSystem) scene.remove(particleSystem);

            // Reduce particles on mobile
            const count = quality === 'high' ? 1000 : (quality === 'medium' ? 500 : 200);
            const geometry = new THREE.BufferGeometry();
            const positions = new Float32Array(count * 3);

            for (let i = 0; i < count; i++) {
                positions[i * 3] = (Math.random() - 0.5) * 30;
                positions[i * 3 + 1] = Math.random() * 15;
                positions[i * 3 + 2] = (Math.random() - 0.5) * 30;
            }

            geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));

            const material = new THREE.PointsMaterial({
                color: quality === 'low' ? 0x00f0ff : 0xffffff,
                size: quality === 'high' ? 0.08 : 0.05,
                transparent: true,
                opacity: 0.6
            });

            particleSystem = new THREE.Points(geometry, material);
            scene.add(particleSystem);
        }

        function createFloor() {
            const gridHelper = new THREE.GridHelper(20, 20, 0x00f0ff, 0x222222);
            gridHelper.position.y = 0;
            gridHelper.material.transparent = true;
            gridHelper.material.opacity = 0.2;
            scene.add(gridHelper);
        }

        function animate() {
            requestAnimationFrame(animate);

            const time = Date.now() * 0.001;

            // FPS Counter
            frameCount++;
            const currentTime = performance.now();
            if (currentTime - lastTime >= 1000) {
                fps = Math.round((frameCount * 1000) / (currentTime - lastTime));
                document.getElementById('fps-counter').textContent = fps + ' FPS';
                frameCount = 0;
                lastTime = currentTime;

                // Auto-reduce quality if FPS is low
                if (fps < 30 && quality === 'high' && isMobile) {
                    setQuality('medium');
                }
            }

            // Rotate main object
            if (autoRotate && mainObject) {
                mainObject.rotation.x = time * 0.15;
                mainObject.rotation.y = time * 0.25;

                if (mainObject.userData.core) {
                    mainObject.userData.core.rotation.y = -time * 0.5;
                }
                if (mainObject.userData.ring) {
                    mainObject.userData.ring.rotation.z = time * 0.2;
                }
            }

            // Particles
            if (particleSystem) {
                particleSystem.rotation.y = time * 0.02;
            }

            controls.update();
            renderer.render(scene, camera);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // Controls
        function toggleAutoRotate() {
            autoRotate = !autoRotate;
            document.getElementById('rotate-btn').style.opacity = autoRotate ? '1' : '0.5';
        }

        function resetCamera() {
            camera.position.set(5, 3, 5);
            controls.target.set(0, 0, 0);
            controls.update();
        }

        function setQuality(q) {
            quality = q;
            const badge = document.getElementById('quality-badge');

            if (q === 'high') {
                badge.className = 'quality-badge quality-high';
                badge.textContent = 'Ultra';
            } else if (q === 'medium') {
                badge.className = 'quality-badge quality-med';
                badge.textContent = 'Balanced';
            } else {
                badge.className = 'quality-badge quality-low';
                badge.textContent = 'Performance';
            }

            // Recreate with new quality
            createMainObject();
            createParticles();
        }

        // Start
        document.addEventListener('DOMContentLoaded', init);

        // Prevent zoom on double tap
        let lastTouchEnd = 0;
        document.addEventListener('touchend', (e) => {
            const now = Date.now();
            if (now - lastTouchEnd <= 300) {
                e.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
    </script>
</body>
</html>